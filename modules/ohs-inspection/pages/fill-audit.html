<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fill OHS Inspection</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: #1e293b;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid rgba(225, 112, 85, 0.3);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-left { display: flex; align-items: center; gap: 1rem; }

        .back-btn {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .back-btn:hover { background: linear-gradient(135deg, #64748b 0%, #475569 100%); }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, #e17055, #d63031);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-right { display: flex; align-items: center; gap: 1rem; }

        .audit-info { display: flex; gap: 1.5rem; font-size: 0.9rem; }

        .audit-info-item { display: flex; align-items: center; gap: 0.5rem; }
        .audit-info-label { color: #64748b; }
        .audit-info-value { color: #1e293b; font-weight: 600; }

        .status-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-in-progress { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .status-completed { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }

        .main-container { display: flex; height: calc(100vh - 70px); }

        .sections-sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            border-right: 1px solid rgba(225, 112, 85, 0.2);
            overflow-y: auto;
            padding: 1rem;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
        }

        .sidebar-title {
            font-size: 1rem;
            font-weight: 600;
            color: #475569;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(225, 112, 85, 0.2);
        }

        .section-nav-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .section-nav-item:hover {
            background: rgba(225, 112, 85, 0.1);
            border-color: rgba(225, 112, 85, 0.3);
        }

        .section-nav-item.active {
            background: rgba(225, 112, 85, 0.2);
            border-color: rgba(225, 112, 85, 0.5);
        }

        .section-nav-icon { font-size: 1.25rem; }
        .section-nav-info { flex: 1; }
        .section-nav-name { font-size: 0.9rem; font-weight: 500; color: #1e293b; }
        .section-nav-progress { font-size: 0.75rem; color: #64748b; }
        .section-nav-score { font-size: 0.85rem; font-weight: 600; }

        .score-pass { color: #10b981; }
        .score-fail { color: #ef4444; }
        .score-na { color: #94a3b8; }

        /* Department grouping styles */
        .department-group {
            margin-bottom: 1rem;
            border: 1px solid rgba(225, 112, 85, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .department-group.na {
            opacity: 0.5;
            border-style: dashed;
        }

        .department-header {
            background: linear-gradient(135deg, rgba(225, 112, 85, 0.15) 0%, rgba(214, 48, 49, 0.1) 100%);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(225, 112, 85, 0.2);
        }

        .department-header:hover {
            background: linear-gradient(135deg, rgba(225, 112, 85, 0.25) 0%, rgba(214, 48, 49, 0.15) 100%);
        }

        .department-icon { font-size: 1.5rem; }
        .department-name { flex: 1; font-weight: 600; color: #1e293b; font-size: 0.95rem; }
        
        .department-score {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 12px;
            background: #f0f0f0;
        }

        .department-score.pass { background: #d1fae5; color: #059669; }
        .department-score.fail { background: #fee2e2; color: #dc2626; }

        .department-toggle-btn {
            background: none;
            border: 1px solid #94a3b8;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #64748b;
        }

        .department-toggle-btn:hover {
            border-color: #e17055;
            color: #e17055;
        }

        .department-toggle-btn.na-active {
            background: #fee2e2;
            border-color: #dc2626;
            color: #dc2626;
        }

        .department-expand {
            font-size: 0.9rem;
            color: #64748b;
            transition: transform 0.3s;
        }

        .department-expand.collapsed {
            transform: rotate(-90deg);
        }

        .department-sections {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .department-sections.collapsed {
            max-height: 0;
        }

        .department-sections .section-nav-item {
            margin: 0;
            border-radius: 0;
            border-bottom: 1px solid rgba(225, 112, 85, 0.1);
            padding-left: 1.5rem;
        }

        .department-sections .section-nav-item:last-child {
            border-bottom: none;
        }

        .content-area { flex: 1; overflow-y: auto; padding: 2rem; }

        .section-header {
            background: linear-gradient(135deg, rgba(225, 112, 85, 0.1) 0%, rgba(214, 48, 49, 0.05) 100%);
            border: 1px solid rgba(225, 112, 85, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title { display: flex; align-items: center; gap: 1rem; }
        .section-icon { font-size: 2rem; }
        .section-name { font-size: 1.5rem; font-weight: 600; color: #1e293b; }
        .section-stats { display: flex; gap: 2rem; align-items: center; }
        .section-stat { text-align: center; }
        .section-stat-value { font-size: 1.5rem; font-weight: 700; }
        .section-stat-label { font-size: 0.8rem; color: #64748b; }

        .question-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(225, 112, 85, 0.2);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .question-card:hover {
            border-color: rgba(225, 112, 85, 0.4);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .question-card.answered { border-left: 4px solid #10b981; }
        .question-card.answered-partial { border-left: 4px solid #f59e0b; }
        .question-card.answered-no { border-left: 4px solid #ef4444; }
        .question-card.answered-na { border-left: 4px solid #64748b; }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .question-ref {
            background: #e17055;
            color: #ffffff;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .question-coeff {
            background: #f97316;
            color: #ffffff;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .question-title {
            font-size: 1rem;
            color: #1e293b;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .answer-options { display: flex; gap: 0.5rem; margin-bottom: 1rem; }

        .answer-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid rgba(225, 112, 85, 0.3);
            border-radius: 8px;
            background: transparent;
            color: #64748b;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .answer-btn:hover {
            border-color: rgba(225, 112, 85, 0.5);
            background: rgba(225, 112, 85, 0.1);
        }

        .answer-btn.selected-yes {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: #10b981;
            color: white;
        }

        .answer-btn.selected-partial {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-color: #f59e0b;
            color: white;
        }

        .answer-btn.selected-no {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-color: #ef4444;
            color: white;
        }

        .answer-btn.selected-na {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            border-color: #64748b;
            color: white;
        }

        .finding-section {
            display: none;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .finding-section.visible { display: block; }

        .finding-group { margin-bottom: 1rem; }
        .finding-label { font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem; }

        .finding-input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(225, 112, 85, 0.3);
            border-radius: 6px;
            color: #1e293b;
            font-size: 0.9rem;
            resize: vertical;
        }

        .finding-input:focus {
            outline: none;
            border-color: rgba(225, 112, 85, 0.6);
        }

        .priority-options { display: flex; gap: 0.5rem; }

        .priority-btn {
            padding: 0.5rem 1rem;
            border: 1px solid rgba(225, 112, 85, 0.3);
            border-radius: 6px;
            background: transparent;
            color: #64748b;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .priority-btn.selected-critical { background: #7c3aed; border-color: #7c3aed; color: white; }
        .priority-btn.selected-high { background: #ef4444; border-color: #ef4444; color: white; }
        .priority-btn.selected-medium { background: #f59e0b; border-color: #f59e0b; color: white; }
        .priority-btn.selected-low { background: #3b82f6; border-color: #3b82f6; color: white; }

        /* Escalate Section */
        .escalate-section {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
        }

        .escalate-checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
        }

        .escalate-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #8b5cf6;
            cursor: pointer;
        }

        .escalate-label {
            font-size: 0.9rem;
            color: #7c3aed;
            font-weight: 500;
        }

        .department-dropdown-wrapper {
            display: none;
            margin-top: 1rem;
        }

        .department-dropdown-wrapper.visible {
            display: block;
        }

        .department-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .department-select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 6px;
            color: #1e293b;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .department-select:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.6);
        }

        .action-bar {
            position: fixed;
            bottom: 0;
            left: 280px;
            right: 0;
            background: white;
            padding: 1rem 2rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
        }

        .progress-info { display: flex; align-items: center; gap: 1rem; }

        .progress-bar {
            width: 200px;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
            transition: width 0.3s;
        }

        .progress-text { font-size: 0.9rem; color: #64748b; }

        .action-buttons { display: flex; gap: 1rem; }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
            color: white;
        }

        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(225, 112, 85, 0.4); }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-secondary { background: #f1f5f9; color: #475569; }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-overlay.show { display: flex; }

        .loading-box {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e17055;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Picture Button */
        .picture-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(225, 112, 85, 0.2);
            border: 1px solid rgba(225, 112, 85, 0.3);
            border-radius: 6px;
            color: #e17055;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }

        .picture-btn:hover {
            background: rgba(225, 112, 85, 0.3);
        }

        .picture-btn.has-picture {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.5);
            color: #10b981;
        }

        /* Image Modal */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .image-modal.show { display: flex; }

        .image-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .image-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .image-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .image-modal-close {
            background: transparent;
            border: none;
            color: #64748b;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        .image-modal-close:hover { color: #ef4444; }

        .image-upload-zone {
            border: 2px dashed rgba(225, 112, 85, 0.5);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-upload-zone:hover {
            border-color: rgba(225, 112, 85, 0.8);
            background: rgba(225, 112, 85, 0.1);
        }

        .image-upload-zone.dragover {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .upload-icon { font-size: 3rem; margin-bottom: 1rem; }
        .upload-text { color: #64748b; font-size: 0.9rem; }

        .image-type-selector { margin-bottom: 1.5rem; }
        .image-type-label { font-size: 0.9rem; color: #64748b; margin-bottom: 0.75rem; }

        .image-type-options {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .image-type-btn {
            padding: 0.75rem 1.25rem;
            border: 2px solid rgba(225, 112, 85, 0.3);
            border-radius: 8px;
            background: transparent;
            color: #64748b;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .image-type-btn:hover {
            border-color: rgba(225, 112, 85, 0.6);
            background: rgba(225, 112, 85, 0.1);
        }

        .image-type-btn.selected {
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
            border-color: #e17055;
            color: white;
        }

        .image-type-btn.type-finding { border-color: rgba(239, 68, 68, 0.5); }
        .image-type-btn.type-finding.selected {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-color: #ef4444;
        }

        .image-type-btn.type-corrective { border-color: rgba(59, 130, 246, 0.5); }
        .image-type-btn.type-corrective.selected {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: #3b82f6;
        }

        .image-preview-container { margin-bottom: 1.5rem; }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
        }

        .existing-images { margin-bottom: 1.5rem; }
        .existing-images-title { font-size: 0.9rem; color: #64748b; margin-bottom: 0.75rem; }

        .existing-image-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: rgba(225, 112, 85, 0.05);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .existing-image-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
        }

        .existing-image-info { flex: 1; }
        .existing-image-type { font-size: 0.85rem; font-weight: 500; }
        .existing-image-type.type-finding { color: #ef4444; }
        .existing-image-type.type-corrective { color: #3b82f6; }
        .existing-image-name { font-size: 0.75rem; color: #64748b; }

        .delete-image-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #ef4444;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
        }

        .delete-image-btn:hover { background: rgba(239, 68, 68, 0.3); }

        .image-modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .modal-btn.cancel { background: rgba(100, 116, 139, 0.3); color: #64748b; }
        .modal-btn.upload { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .modal-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        @media (max-width: 768px) {
            .sections-sidebar { display: none; }
            .action-bar { left: 0; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <a href="/ohs-inspection/list" class="back-btn">‚Üê Back</a>
            <span class="header-title">ü¶∫ OHS Inspection</span>
        </div>
        <div class="header-right">
            <div class="audit-info">
                <div class="audit-info-item">
                    <span class="audit-info-label">Doc:</span>
                    <span class="audit-info-value" id="docNumber">-</span>
                </div>
                <div class="audit-info-item">
                    <span class="audit-info-label">Store:</span>
                    <span class="audit-info-value" id="storeName">-</span>
                </div>
            </div>
            <span class="status-badge status-in-progress" id="statusBadge">Draft</span>
        </div>
    </div>

    <div class="main-container">
        <div class="sections-sidebar">
            <div class="sidebar-title">üè¨ Departments & Sections</div>
            <div id="sectionsList"></div>
        </div>

        <div class="content-area" id="contentArea">
            <div class="loading-box">
                <div class="spinner"></div>
                <p>Loading inspection...</p>
            </div>
        </div>
    </div>

    <div class="action-bar">
        <div class="progress-info">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <span class="progress-text" id="progressText">0 / 0 answered</span>
        </div>
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="saveProgress()">üíæ Save Progress</button>
            <button class="btn btn-primary" onclick="generateReport()">üìÑ Generate Report</button>
            <button class="btn btn-success" onclick="completeAudit()">‚úÖ Complete</button>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-box">
            <div class="spinner"></div>
            <p id="loadingText">Processing...</p>
        </div>
    </div>

    <!-- Image Upload Modal -->
    <div class="image-modal" id="imageModal">
        <div class="image-modal-content">
            <div class="image-modal-header">
                <span class="image-modal-title">üì∑ Manage Pictures</span>
                <button class="image-modal-close" onclick="closeImageModal()">√ó</button>
            </div>

            <!-- Existing Images -->
            <div class="existing-images" id="existingImages" style="display: none;">
                <div class="existing-images-title">üìé Attached Images</div>
                <div id="existingImagesList"></div>
            </div>

            <!-- Upload Zone -->
            <div class="image-upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">üì§</div>
                <div class="upload-text">Click or drag & drop to upload image</div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
            </div>

            <!-- Image Preview -->
            <div class="image-preview-container" id="previewContainer" style="display: none;">
                <img id="imagePreview" class="image-preview" src="" alt="Preview">
            </div>

            <!-- Image Type Selector -->
            <div class="image-type-selector" id="typeSelector" style="display: none;">
                <div class="image-type-label">Select image type:</div>
                <div class="image-type-options">
                    <button class="image-type-btn type-finding" onclick="selectImageType('Finding')">
                        ‚ùå Finding
                    </button>
                    <button class="image-type-btn type-corrective" onclick="selectImageType('Corrective')">
                        üîß Corrective Action
                    </button>
                </div>
            </div>

            <!-- Actions -->
            <div class="image-modal-actions">
                <button class="modal-btn cancel" onclick="closeImageModal()">Cancel</button>
                <button class="modal-btn upload" id="uploadBtn" onclick="uploadImage()" disabled>Upload Image</button>
            </div>
        </div>
    </div>

    <script>
        let auditData = null;
        let currentSectionIndex = 0;

        // Get audit ID from URL
        const pathParts = window.location.pathname.split('/');
        const auditId = pathParts[pathParts.length - 1];

        async function loadAudit() {
            try {
                const response = await fetch(`/ohs-inspection/api/audits/${auditId}`);
                const result = await response.json();

                if (result.success) {
                    auditData = result.data;
                    renderAudit();
                } else {
                    alert('Error loading audit: ' + result.error);
                    window.location.href = '/ohs-inspection/list';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to load audit');
            }
        }

        function renderAudit() {
            document.getElementById('docNumber').textContent = auditData.documentNumber;
            document.getElementById('storeName').textContent = auditData.storeName;
            document.getElementById('statusBadge').textContent = auditData.status;
            document.getElementById('statusBadge').className = `status-badge status-${auditData.status === 'Completed' ? 'completed' : 'in-progress'}`;

            renderSectionsSidebar();
            renderCurrentSection();
            updateProgress();
        }

        function renderSectionsSidebar() {
            const container = document.getElementById('sectionsList');
            
            if (!auditData.sections || auditData.sections.length === 0) {
                container.innerHTML = '<p style="color: #64748b; padding: 1rem;">No sections found. Please configure a template first.</p>';
                return;
            }

            // Check if we have departments
            const hasDepartments = auditData.departments && auditData.departments.length > 0;
            
            if (hasDepartments) {
                // Group sections by department
                let html = '';
                
                for (const dept of auditData.departments) {
                    const deptSections = auditData.sections.filter(s => s.departmentName === dept.departmentName);
                    const isNA = dept.isNA;
                    const isCollapsed = window.collapsedDepartments && window.collapsedDepartments[dept.departmentId];
                    
                    // Calculate department score
                    let deptAnswered = 0, deptTotal = 0, deptEarned = 0, deptMax = 0;
                    for (const section of deptSections) {
                        for (const item of section.items || []) {
                            deptTotal++;
                            if (item.selectedChoice) deptAnswered++;
                            if (item.selectedChoice && item.selectedChoice !== 'NA') {
                                const coeff = parseFloat(item.coeff) || 1;
                                deptMax += coeff;
                                if (item.selectedChoice === 'Yes') deptEarned += coeff;
                                else if (item.selectedChoice === 'Partially') deptEarned += coeff * 0.5;
                            }
                        }
                    }
                    const deptScore = deptMax > 0 ? Math.round((deptEarned / deptMax) * 100) : 0;
                    const passingGrade = dept.passingGrade || 80;
                    
                    html += `
                        <div class="department-group ${isNA ? 'na' : ''}">
                            <div class="department-header" onclick="toggleDepartmentCollapse(${dept.departmentId})">
                                <span class="department-expand ${isCollapsed ? 'collapsed' : ''}">‚ñº</span>
                                <span class="department-icon">${dept.departmentIcon || 'üè¨'}</span>
                                <span class="department-name">${dept.departmentName}</span>
                                ${isNA ? '<span style="color: #94a3b8; font-size: 0.75rem;">N/A</span>' : 
                                  `<span class="department-score ${deptScore >= passingGrade ? 'pass' : deptScore > 0 ? 'fail' : ''}">${deptScore > 0 ? deptScore + '%' : '-'}</span>`}
                                <button class="department-toggle-btn ${isNA ? 'na-active' : ''}" onclick="event.stopPropagation(); toggleDepartmentNA(${dept.departmentId}, ${!isNA})">
                                    ${isNA ? '‚Ü©Ô∏è Restore' : 'N/A'}
                                </button>
                            </div>
                            <div class="department-sections ${isCollapsed ? 'collapsed' : ''}">
                    `;
                    
                    for (const section of deptSections) {
                        const sectionIndex = auditData.sections.indexOf(section);
                        const answered = section.items ? section.items.filter(i => i.selectedChoice).length : 0;
                        const total = section.items ? section.items.length : 0;
                        const score = calculateSectionScore(section);
                        
                        html += `
                            <div class="section-nav-item ${sectionIndex === currentSectionIndex ? 'active' : ''}" onclick="selectSection(${sectionIndex})" style="${isNA ? 'opacity: 0.5;' : ''}">
                                <div class="section-nav-icon">${section.sectionIcon || 'üìã'}</div>
                                <div class="section-nav-info">
                                    <div class="section-nav-name">${section.sectionName}</div>
                                    <div class="section-nav-progress">${answered} / ${total} answered</div>
                                </div>
                                <div class="section-nav-score ${score >= 80 ? 'score-pass' : score > 0 ? 'score-fail' : 'score-na'}">
                                    ${score > 0 ? score + '%' : '-'}
                                </div>
                            </div>
                        `;
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                // Also show sections without department (legacy)
                const orphanSections = auditData.sections.filter(s => !s.departmentName);
                if (orphanSections.length > 0) {
                    html += '<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #ccc;"><small style="color: #94a3b8;">Other Sections:</small></div>';
                    for (const section of orphanSections) {
                        const sectionIndex = auditData.sections.indexOf(section);
                        const answered = section.items ? section.items.filter(i => i.selectedChoice).length : 0;
                        const total = section.items ? section.items.length : 0;
                        const score = calculateSectionScore(section);
                        
                        html += `
                            <div class="section-nav-item ${sectionIndex === currentSectionIndex ? 'active' : ''}" onclick="selectSection(${sectionIndex})">
                                <div class="section-nav-icon">${section.sectionIcon || 'üìã'}</div>
                                <div class="section-nav-info">
                                    <div class="section-nav-name">${section.sectionName}</div>
                                    <div class="section-nav-progress">${answered} / ${total} answered</div>
                                </div>
                                <div class="section-nav-score ${score >= 80 ? 'score-pass' : score > 0 ? 'score-fail' : 'score-na'}">
                                    ${score > 0 ? score + '%' : '-'}
                                </div>
                            </div>
                        `;
                    }
                }
                
                container.innerHTML = html;
            } else {
                // No departments - show sections directly (legacy behavior)
                container.innerHTML = auditData.sections.map((section, index) => {
                    const answered = section.items ? section.items.filter(i => i.selectedChoice).length : 0;
                    const total = section.items ? section.items.length : 0;
                    const score = calculateSectionScore(section);

                    return `
                        <div class="section-nav-item ${index === currentSectionIndex ? 'active' : ''}" onclick="selectSection(${index})">
                            <div class="section-nav-icon">${section.sectionIcon || 'üìã'}</div>
                            <div class="section-nav-info">
                                <div class="section-nav-name">${section.sectionName}</div>
                                <div class="section-nav-progress">${answered} / ${total} answered</div>
                            </div>
                            <div class="section-nav-score ${score >= 80 ? 'score-pass' : score > 0 ? 'score-fail' : 'score-na'}">
                                ${score > 0 ? score + '%' : '-'}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        // Toggle department collapse state
        window.collapsedDepartments = {};
        function toggleDepartmentCollapse(departmentId) {
            window.collapsedDepartments[departmentId] = !window.collapsedDepartments[departmentId];
            renderSectionsSidebar();
        }
        
        // Toggle department NA status
        async function toggleDepartmentNA(departmentId, setNA) {
            try {
                const response = await fetch(`/ohs-inspection/api/audits/${auditId}/departments/${departmentId}/toggle-na`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isNA: setNA })
                });
                
                const result = await response.json();
                if (result.success) {
                    // Update local data
                    const dept = auditData.departments.find(d => d.departmentId === departmentId);
                    if (dept) dept.isNA = setNA;
                    
                    // Update sections in local data
                    for (const section of auditData.sections) {
                        if (section.departmentName === dept.departmentName) {
                            section.departmentIsNA = setNA;
                        }
                    }
                    
                    renderSectionsSidebar();
                    updateProgress();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error toggling department NA:', error);
                alert('Failed to update department');
            }
        }

        function selectSection(index) {
            currentSectionIndex = index;
            renderSectionsSidebar();
            renderCurrentSection();
        }

        function renderCurrentSection() {
            const container = document.getElementById('contentArea');
            
            if (!auditData.sections || auditData.sections.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 4rem;">
                        <h2>No sections configured</h2>
                        <p style="color: #64748b; margin: 1rem 0;">Please create a template with sections and questions first.</p>
                        <a href="/ohs-inspection/template-builder" class="btn btn-primary">üîß Open Template Builder</a>
                    </div>
                `;
                return;
            }

            const section = auditData.sections[currentSectionIndex];
            const score = calculateSectionScore(section);
            const answered = section.items ? section.items.filter(i => i.selectedChoice).length : 0;
            const total = section.items ? section.items.length : 0;
            
            // Check if this section's department is NA
            const dept = section.departmentName ? 
                auditData.departments?.find(d => d.departmentName === section.departmentName) : null;
            const isNA = dept?.isNA;
            
            // Build department badge HTML if section has a department
            const deptBadgeHtml = section.departmentName ? `
                <div style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.25rem;">${dept?.departmentIcon || 'üè¨'}</span>
                    <span style="font-weight: 600; color: #64748b;">${section.departmentName}</span>
                    ${isNA ? '<span style="background: #fee2e2; color: #dc2626; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 600;">N/A - Excluded from scoring</span>' : ''}
                </div>
            ` : '';

            container.innerHTML = `
                ${deptBadgeHtml}
                ${isNA ? '<div style="background: #fef3cd; border: 1px solid #ffc107; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; color: #856404;"><strong>‚ö†Ô∏è This department is marked as N/A.</strong> Answers here will not affect the overall score.</div>' : ''}
                <div class="section-header" style="${isNA ? 'opacity: 0.6;' : ''}">
                    <div class="section-title">
                        <div class="section-icon">${section.sectionIcon || 'üìã'}</div>
                        <div class="section-name">${section.sectionName}</div>
                    </div>
                    <div class="section-stats">
                        <div class="section-stat">
                            <div class="section-stat-value">${answered}/${total}</div>
                            <div class="section-stat-label">Answered</div>
                        </div>
                        <div class="section-stat">
                            <div class="section-stat-value ${score >= 80 ? 'score-pass' : score > 0 ? 'score-fail' : ''}">${score > 0 ? score + '%' : '-'}</div>
                            <div class="section-stat-label">Score</div>
                        </div>
                    </div>
                </div>

                ${(section.items || []).map(item => renderQuestionCard(item, isNA)).join('')}

                <div style="height: 100px;"></div>
            `;
        }

        function renderQuestionCard(item, isNA = false) {
            const answerClass = item.selectedChoice === 'Yes' ? 'answered' :
                               item.selectedChoice === 'Partially' ? 'answered-partial' :
                               item.selectedChoice === 'No' ? 'answered-no' :
                               item.selectedChoice === 'NA' ? 'answered-na' : '';

            const showFinding = item.selectedChoice === 'No' || item.selectedChoice === 'Partially';
            const hasPicture = item.hasPicture;

            return `
                <div class="question-card ${answerClass}" id="question-${item.responseId}" style="${isNA ? 'opacity: 0.6;' : ''}">
                    <div class="question-header">
                        <span class="question-ref">${item.referenceValue || '#'}</span>
                        <span class="question-coeff">√ó${item.coeff || 1}</span>
                    </div>
                    <div class="question-title">${item.title || 'No question text'}</div>

                    <div class="answer-options">
                        <button class="answer-btn ${item.selectedChoice === 'Yes' ? 'selected-yes' : ''}" 
                                onclick="selectAnswer(${item.responseId}, 'Yes', ${item.coeff || 1})">‚úì Yes</button>
                        <button class="answer-btn ${item.selectedChoice === 'Partially' ? 'selected-partial' : ''}" 
                                onclick="selectAnswer(${item.responseId}, 'Partially', ${item.coeff || 1})">‚óê Partial</button>
                        <button class="answer-btn ${item.selectedChoice === 'No' ? 'selected-no' : ''}" 
                                onclick="selectAnswer(${item.responseId}, 'No', ${item.coeff || 1})">‚úó No</button>
                        <button class="answer-btn ${item.selectedChoice === 'NA' ? 'selected-na' : ''}" 
                                onclick="selectAnswer(${item.responseId}, 'NA', ${item.coeff || 1})">N/A</button>
                    </div>

                    <div class="finding-section ${showFinding ? 'visible' : ''}" id="finding-${item.responseId}">
                        <div class="finding-group">
                            <div class="finding-label">Finding / Issue</div>
                            <textarea class="finding-input" placeholder="Describe the finding..." 
                                      onchange="updateFinding(${item.responseId}, 'finding', this.value)">${item.finding || ''}</textarea>
                        </div>
                        <div class="finding-group">
                            <div class="finding-label">Corrective Action</div>
                            <textarea class="finding-input" placeholder="Suggested corrective action..." 
                                      onchange="updateFinding(${item.responseId}, 'cr', this.value)">${item.cr || ''}</textarea>
                        </div>
                        <div class="finding-group">
                            <div class="finding-label">Priority</div>
                            <div class="priority-options">
                                <button class="priority-btn ${item.priority === 'Critical' ? 'selected-critical' : ''}" 
                                        onclick="updateFinding(${item.responseId}, 'priority', 'Critical')">üü£ Critical</button>
                                <button class="priority-btn ${item.priority === 'High' ? 'selected-high' : ''}" 
                                        onclick="updateFinding(${item.responseId}, 'priority', 'High')">üî¥ High</button>
                                <button class="priority-btn ${item.priority === 'Medium' ? 'selected-medium' : ''}" 
                                        onclick="updateFinding(${item.responseId}, 'priority', 'Medium')">üü° Medium</button>
                                <button class="priority-btn ${item.priority === 'Low' ? 'selected-low' : ''}" 
                                        onclick="updateFinding(${item.responseId}, 'priority', 'Low')">üîµ Low</button>
                            </div>
                        </div>
                        <button class="picture-btn ${hasPicture ? 'has-picture' : ''}" onclick="openImageModal(${item.responseId})">
                            üì∑ ${hasPicture ? 'View/Add Pictures' : 'Add Picture'}
                        </button>
                        
                        <!-- Escalate Section -->
                        <div class="escalate-section">
                            <label class="escalate-checkbox-wrapper">
                                <input type="checkbox" class="escalate-checkbox" 
                                    id="escalate-${item.responseId}"
                                    ${item.escalate ? 'checked' : ''}
                                    onchange="toggleEscalate(${item.responseId}, this.checked)">
                                <span class="escalate-label">Assign to Department</span>
                            </label>
                            <div class="department-dropdown-wrapper ${item.escalate ? 'visible' : ''}" id="dept-wrapper-${item.responseId}">
                                <div class="department-label">üìã Assign to Department</div>
                                <select class="department-select" id="dept-${item.responseId}" 
                                    onchange="setDepartment(${item.responseId}, this.value)">
                                    <option value="">-- Select Department --</option>
                                    <option value="Maintenance" ${item.department === 'Maintenance' ? 'selected' : ''}>Maintenance</option>
                                    <option value="HR" ${item.department === 'HR' ? 'selected' : ''}>HR</option>
                                    <option value="Safety" ${item.department === 'Safety' ? 'selected' : ''}>Safety</option>
                                    <option value="Operations" ${item.department === 'Operations' ? 'selected' : ''}>Operations</option>
                                    <option value="Management" ${item.department === 'Management' ? 'selected' : ''}>Management</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function selectAnswer(responseId, choice, coeff) {
            try {
                const response = await fetch(`/ohs-inspection/api/audits/response/${responseId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selectedChoice: choice, coeff })
                });

                if (response.ok) {
                    // Update local data
                    for (const section of auditData.sections) {
                        const item = section.items?.find(i => i.responseId === responseId);
                        if (item) {
                            item.selectedChoice = choice;
                            break;
                        }
                    }
                    renderSectionsSidebar();
                    renderCurrentSection();
                    updateProgress();
                }
            } catch (error) {
                console.error('Error updating answer:', error);
            }
        }

        async function updateFinding(responseId, field, value) {
            try {
                const body = {};
                body[field] = value;

                await fetch(`/ohs-inspection/api/audits/response/${responseId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                // Update local data
                for (const section of auditData.sections) {
                    const item = section.items?.find(i => i.responseId === responseId);
                    if (item) {
                        item[field] = value;
                        break;
                    }
                }

                if (field === 'priority') {
                    renderCurrentSection();
                }
            } catch (error) {
                console.error('Error updating finding:', error);
            }
        }

        // Find item helper
        function findItem(responseId) {
            for (const section of auditData.sections || []) {
                const item = section.items?.find(i => i.responseId === responseId);
                if (item) return item;
            }
            return null;
        }

        // Toggle escalate checkbox
        async function toggleEscalate(responseId, checked) {
            try {
                const item = findItem(responseId);
                const response = await fetch(`/ohs-inspection/api/audits/response/${responseId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        selectedChoice: item.selectedChoice,
                        coeff: item.coeff,
                        escalate: checked,
                        department: checked ? item.department : null
                    })
                });

                const result = await response.json();
                if (!result.success) throw new Error(result.error);

                // Update local data
                if (item) {
                    item.escalate = checked;
                    if (!checked) item.department = null;
                }

                // Show/hide department dropdown
                const deptWrapper = document.getElementById(`dept-wrapper-${responseId}`);
                if (deptWrapper) {
                    deptWrapper.classList.toggle('visible', checked);
                }

            } catch (error) {
                console.error('Error toggling escalate:', error);
                alert('Failed to save escalation');
            }
        }

        // Set department
        async function setDepartment(responseId, department) {
            try {
                const item = findItem(responseId);
                const response = await fetch(`/ohs-inspection/api/audits/response/${responseId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        selectedChoice: item.selectedChoice,
                        coeff: item.coeff,
                        escalate: item.escalate,
                        department: department || null
                    })
                });

                const result = await response.json();
                if (!result.success) throw new Error(result.error);

                // Update local data
                if (item) item.department = department;

            } catch (error) {
                console.error('Error setting department:', error);
                alert('Failed to save department');
            }
        }

        function calculateSectionScore(section) {
            if (!section.items || section.items.length === 0) return 0;

            let earned = 0, max = 0;
            for (const item of section.items) {
                if (item.selectedChoice && item.selectedChoice !== 'NA') {
                    const coeff = parseFloat(item.coeff) || 1;
                    max += coeff;
                    if (item.selectedChoice === 'Yes') earned += coeff;
                    else if (item.selectedChoice === 'Partially') earned += coeff * 0.5;
                }
            }
            return max > 0 ? Math.round((earned / max) * 100) : 0;
        }

        function updateProgress() {
            let answered = 0, total = 0;
            
            // Get list of NA department names
            const naDepartments = (auditData.departments || [])
                .filter(d => d.isNA)
                .map(d => d.departmentName);
            
            for (const section of auditData.sections || []) {
                // Skip sections in NA departments
                if (section.departmentName && naDepartments.includes(section.departmentName)) {
                    continue;
                }
                
                for (const item of section.items || []) {
                    total++;
                    if (item.selectedChoice) answered++;
                }
            }

            const percent = total > 0 ? Math.round((answered / total) * 100) : 0;
            document.getElementById('progressFill').style.width = percent + '%';
            
            // Show NA department count if any
            const naCount = naDepartments.length;
            const naText = naCount > 0 ? ` (${naCount} dept N/A)` : '';
            document.getElementById('progressText').textContent = `${answered} / ${total} answered (${percent}%)${naText}`;
        }

        async function saveProgress() {
            showLoading('Saving progress...');
            // Already auto-saved on each answer
            setTimeout(() => {
                hideLoading();
                alert('Progress saved successfully!');
            }, 500);
        }

        async function generateReport() {
            showLoading('Generating report...');
            try {
                const response = await fetch(`/ohs-inspection/api/audits/${auditId}/generate-report`, {
                    method: 'POST'
                });
                const result = await response.json();

                hideLoading();
                if (result.success) {
                    alert(`Report generated!\nScore: ${result.overallScore}%\nFile: ${result.fileName}`);
                    window.open(`/ohs-inspection/api/audits/reports/${result.fileName}`, '_blank');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                hideLoading();
                alert('Error generating report');
            }
        }

        async function completeAudit() {
            if (!confirm('Are you sure you want to complete this inspection?')) return;

            showLoading('Completing inspection...');
            try {
                const response = await fetch(`/ohs-inspection/api/audits/${auditId}/complete`, {
                    method: 'POST'
                });
                const result = await response.json();

                hideLoading();
                if (result.success) {
                    alert(`Inspection completed!\nFinal Score: ${Math.round(result.data.totalScore)}%`);
                    loadAudit();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                hideLoading();
                alert('Error completing inspection');
            }
        }

        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        // ==========================================
        // Image Upload Functions
        // ==========================================
        
        let currentImageResponseId = null;
        let selectedImageFile = null;
        let selectedImageType = null;

        // Open image modal
        function openImageModal(responseId) {
            currentImageResponseId = responseId;
            selectedImageFile = null;
            selectedImageType = null;
            
            // Reset modal state
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('typeSelector').style.display = 'none';
            document.getElementById('uploadBtn').disabled = true;
            document.querySelectorAll('.image-type-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('fileInput').value = '';
            
            // Load existing images
            loadExistingImages(responseId);
            
            // Show modal
            document.getElementById('imageModal').classList.add('show');
        }

        // Close image modal
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('show');
            currentImageResponseId = null;
            selectedImageFile = null;
            selectedImageType = null;
        }

        // Handle file select
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }
            
            selectedImageFile = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('previewContainer').style.display = 'block';
                document.getElementById('typeSelector').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // Select image type
        function selectImageType(type) {
            selectedImageType = type;
            document.querySelectorAll('.image-type-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('uploadBtn').disabled = !selectedImageFile;
        }

        // Upload image
        async function uploadImage() {
            if (!selectedImageFile || !selectedImageType) {
                alert('Please select an image and type');
                return;
            }
            
            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64 = e.target.result.split(',')[1];
                    
                    const response = await fetch(`/ohs-inspection/api/audits/pictures`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            responseId: currentImageResponseId,
                            auditId: auditData.auditId,
                            fileName: selectedImageFile.name,
                            contentType: selectedImageFile.type,
                            pictureType: selectedImageType,
                            fileData: base64
                        })
                    });
                    
                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);
                    
                    alert('Image uploaded successfully!');
                    
                    // Update local data
                    for (const section of auditData.sections) {
                        const item = section.items?.find(i => i.responseId === currentImageResponseId);
                        if (item) {
                            item.hasPicture = true;
                            break;
                        }
                    }
                    
                    // Re-render
                    renderCurrentSection();
                    
                    // Reload images list
                    loadExistingImages(currentImageResponseId);
                    
                    // Reset upload form
                    document.getElementById('previewContainer').style.display = 'none';
                    document.getElementById('typeSelector').style.display = 'none';
                    document.getElementById('uploadBtn').disabled = true;
                    document.querySelectorAll('.image-type-btn').forEach(btn => btn.classList.remove('selected'));
                    document.getElementById('fileInput').value = '';
                    selectedImageFile = null;
                    selectedImageType = null;
                };
                reader.readAsDataURL(selectedImageFile);
                
            } catch (error) {
                console.error('Error uploading image:', error);
                alert('Failed to upload image: ' + error.message);
            }
        }

        // Load existing images for a response
        async function loadExistingImages(responseId) {
            try {
                const response = await fetch(`/ohs-inspection/api/audits/pictures/${responseId}`);
                const result = await response.json();
                
                const container = document.getElementById('existingImages');
                const list = document.getElementById('existingImagesList');
                
                if (result.success && result.data.length > 0) {
                    list.innerHTML = result.data.map(pic => `
                        <div class="existing-image-item">
                            <img src="data:${pic.contentType};base64,${pic.fileData}" class="existing-image-thumb" alt="${pic.fileName}">
                            <div class="existing-image-info">
                                <div class="existing-image-type type-${pic.pictureType.toLowerCase()}">${getTypeLabel(pic.pictureType)}</div>
                                <div class="existing-image-name">${pic.fileName}</div>
                            </div>
                            <button class="delete-image-btn" onclick="deleteImage(${pic.pictureId})">üóëÔ∏è</button>
                        </div>
                    `).join('');
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading images:', error);
            }
        }

        // Get type label with icon
        function getTypeLabel(type) {
            switch (type) {
                case 'Finding': return '‚ùå Finding';
                case 'Corrective': return 'üîß Corrective Action';
                default: return type;
            }
        }

        // Delete image
        async function deleteImage(pictureId) {
            if (!confirm('Are you sure you want to delete this image?')) return;
            
            try {
                const response = await fetch(`/ohs-inspection/api/audits/pictures/${pictureId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (!result.success) throw new Error(result.error);
                
                alert('Image deleted');
                loadExistingImages(currentImageResponseId);
                renderCurrentSection();
                
            } catch (error) {
                console.error('Error deleting image:', error);
                alert('Failed to delete image');
            }
        }

        // Setup drag and drop
        document.addEventListener('DOMContentLoaded', function() {
            const uploadZone = document.getElementById('uploadZone');
            
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    document.getElementById('fileInput').files = e.dataTransfer.files;
                    handleFileSelect({ target: { files: [file] } });
                }
            });
        });

        // Load on page load
        loadAudit();
    </script>
</body>
</html>
